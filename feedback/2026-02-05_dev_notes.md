# NAVIG 개발 일지 - 2026-02-05

## 오늘의 작업 요약

페이지 로딩 속도 최적화 및 편집 프로젝트 썸네일 기능 구현

---

## 1. 성능 최적화 (Performance Optimization)

### 1.1 인증 플로우 최적화

**문제:** 모든 페이지 로딩 시 불필요한 네트워크 호출로 인한 지연

**원인 분석:**
- Middleware에서 `supabase.auth.getUser()` 호출 (서버 검증, 네트워크 왕복)
- Dashboard Layout에서 동일한 `getUser()` 중복 호출
- 프로필 쿼리 중복 실행

**해결책:**

| 파일 | 변경 내용 |
|------|----------|
| `src/middleware.ts` | `getUser()` → `getSession()` (JWT 토큰만 검증, 서버 왕복 제거) |
| `src/app/(dashboard)/layout.tsx` | React `cache()` 함수로 요청 단위 중복 호출 방지 |

```typescript
// middleware.ts - 변경 전
const { data: { user } } = await supabase.auth.getUser();

// middleware.ts - 변경 후
const { data: { session } } = await supabase.auth.getSession();
```

```typescript
// layout.tsx - React cache 적용
import { cache } from 'react';

const getUser = cache(async () => {
  const supabase = await createClient();
  return supabase.auth.getUser();
});

const getProfile = cache(async (userId: string) => {
  const supabase = await createClient();
  return supabase.from('profiles').select('name, avatar_url, sidebar_config').eq('id', userId).single();
});
```

### 1.2 Dynamic Import 적용

**문제:** 무거운 라이브러리가 초기 번들에 포함되어 First Load JS 증가

**해결책:**

| 라이브러리 | 크기 | 적용 방식 |
|-----------|------|----------|
| HLS.js | ~200KB | useEffect 내 동적 import |
| recharts | ~300KB | next/dynamic (ssr: false) |
| VideoCompareModal | ~50KB | next/dynamic |
| VideoDiffAnalyzer | ~30KB | next/dynamic |

**구현 예시:**

```typescript
// HLS.js 동적 import (src/app/(dashboard)/projects/[id]/videos/[videoId]/page.tsx)
useEffect(() => {
  async function initHls() {
    const HlsModule = await import('hls.js');
    const Hls = HlsModule.default;

    if (Hls.isSupported()) {
      const hls = new Hls({ enableWorker: true });
      hls.loadSource(hlsUrl);
      hls.attachMedia(videoElement);
    }
  }
  initHls();
}, []);
```

```typescript
// recharts 동적 import (src/components/dashboard/DashboardChartsLazy.tsx)
const ProjectStatusChartInternal = dynamic(
  () => import('./DashboardCharts').then(mod => ({ default: mod.ProjectStatusChart })),
  { loading: () => <ChartSkeleton title="프로젝트 현황" />, ssr: false }
);
```

### 1.3 최적화 결과

| 페이지 | 변경 전 | 변경 후 | 감소율 |
|--------|---------|---------|--------|
| Video Review | ~454KB | 271KB | **~40%** |
| Dashboard | ~160KB | 126KB | ~21% |

---

## 2. 편집 프로젝트 썸네일 (Edit Project Thumbnail)

### 2.1 기능 설명

영상 업로드 시 자동으로 썸네일을 생성하여 편집 프로젝트 목록에 표시

### 2.2 구현 내용

**썸네일 생성 로직 (Canvas API):**

```typescript
// src/components/editing/workspace/VideoUploader.tsx
function generateThumbnail(file: File, seekTime?: number): Promise<Blob | null> {
  return new Promise((resolve) => {
    const video = document.createElement('video');
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    video.onloadedmetadata = () => {
      // 영상 길이의 25% 지점 (최대 5초)
      const targetTime = seekTime ?? Math.min(video.duration * 0.25, 5);
      video.currentTime = targetTime;
    };

    video.onseeked = () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx?.drawImage(video, 0, 0);
      canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.8);
    };

    video.src = URL.createObjectURL(file);
  });
}
```

### 2.3 새 API 엔드포인트

| 메서드 | 경로 | 설명 |
|--------|------|------|
| POST | `/api/projects/[id]/edits/[editId]/thumbnail` | 썸네일 업로드 |

### 2.4 저장 경로

```
navig-src/
└── edit-thumbnails/
    └── {project_id}/
        └── {edit_id}.jpg
```

### 2.5 DB 필드

`edit_projects.preview_thumbnail_url` - 이미 마이그레이션에 존재, 이번에 연동 완료

---

## 3. 코드 정리 및 리팩토링

### 3.1 타입 통합

| 파일 | 변경 내용 |
|------|----------|
| `src/types/database.ts` | Database 타입 전체 정의 추가 (+851줄) |
| `src/types/chat.ts` | 중복 타입 제거 (-14줄) |
| `src/types/feedback.ts` | 중복 타입 제거 (-24줄) |
| `src/types/feedback-template.ts` | 중복 타입 제거 (-10줄) |

### 3.2 삭제된 파일

| 파일 | 이유 |
|------|------|
| `src/lib/supabase/helpers.ts` | 사용되지 않는 코드 제거 (-218줄) |

### 3.3 새로 추가된 파일

| 파일 | 설명 |
|------|------|
| `src/components/dashboard/DashboardChartsLazy.tsx` | 차트 컴포넌트 지연 로딩 래퍼 |
| `src/components/chat/DragDropOverlay.tsx` | 채팅 드래그 드롭 오버레이 |
| `src/components/chat/ScrollToBottomButton.tsx` | 채팅 스크롤 버튼 |
| `src/components/editing/workspace/panels/SubtitlePanel.tsx` | 자막 패널 |
| `src/hooks/use-drag-and-drop.ts` | 드래그 드롭 훅 |
| `src/lib/api/` | API 유틸리티 |
| `src/lib/chat/` | 채팅 유틸리티 |
| `src/lib/logger.ts` | 로깅 유틸리티 |
| `src/lib/utils/` | 공통 유틸리티 |
| `src/app/api/projects/[id]/edits/[editId]/thumbnail/route.ts` | 썸네일 API |

---

## 4. 규칙 업데이트

### 4.1 DESIGN_SYSTEM.md

**추가된 섹션:**
- §12: 접근성 (키보드 네비게이션, ARIA, 포커스 관리)
- §13: 로딩/스켈레톤 패턴

### 4.2 ERROR_PREVENTION.md

**추가된 섹션:**
- §32: HLS.js 동적 import 패턴
- §33: React cache() 사용 패턴

### 4.3 STORAGE_RULES.md

**추가된 항목:**
- `edit-thumbnails/` 폴더 구조 문서화

---

## 5. 마이그레이션

| 파일 | 설명 |
|------|------|
| `00033_subtitle_edit_project.sql` | video_subtitles에 edit_project_id 컬럼 추가 |

---

## 6. 파일 변경 통계

```
총 변경 파일: 43개
- 수정: 29개
- 추가: 13개
- 삭제: 1개
총 변경 라인: +2,380 / -816
```

### 주요 변경 파일

| 파일 | 변경 내용 |
|------|----------|
| `src/app/(dashboard)/projects/[id]/videos/[videoId]/page.tsx` | HLS 동적 import (+99줄) |
| `src/types/database.ts` | 전체 DB 타입 정의 (+851줄) |
| `src/app/api/ai/subtitles/route.ts` | 자막 API 개선 (+411줄) |
| `src/components/editing/workspace/Timeline.tsx` | 타임라인 개선 (+288줄) |
| `src/lib/supabase/helpers.ts` | 삭제 (-218줄) |
| `.claude/rules/ERROR_PREVENTION.md` | 규칙 추가 (+197줄) |
| `.claude/rules/DESIGN_SYSTEM.md` | 접근성 섹션 추가 (+172줄) |

---

## 7. 알려진 이슈

없음

---

## 8. 다음 작업 예정

1. 편집 워크스페이스 자막 패널 구현
2. 타임라인 자막 표시
3. 자막 내보내기 (SRT, VTT)

---

**작성자:** Claude Code
**커밋:** 성능 최적화 + 편집 프로젝트 썸네일 + 타입 정리
