# NAVIG 개발 일지 - 2026-02-02

## 오늘의 작업 요약

영상 비교 컴포넌트 HLS 스트리밍 지원, 오디오 개별 제어, 피드백 시스템 개선, 배포 준비를 위한 디버그 로그 정리

---

## 1. 신규 기능 개발

### 1.1 영상 비교 컴포넌트 HLS 스트리밍 지원

**구현 내용:**
- 모든 비교 모드(SliderCompare, WipeCompare, SideBySideCompare, OverlayCompare)에 HLS 스트리밍 지원 추가
- hls.js 라이브러리 통합
- Safari 네이티브 HLS 지원 폴백

**기술 세부사항:**
- 비디오 URL에 `isHls` 플래그로 HLS 여부 판단
- HLS 인스턴스 생명주기 관리 (생성/파괴)
- 컴포넌트 언마운트 시 리소스 정리

**수정된 파일:**
- `src/components/video/compare/SliderCompare.tsx`
- `src/components/video/compare/WipeCompare.tsx`
- `src/components/video/compare/SideBySideCompare.tsx`
- `src/components/video/compare/OverlayCompare.tsx`

### 1.2 영상 비교 모달 오디오 개별 제어

**구현 내용:**
- 좌측/우측 영상 개별 음소거 토글
- 개별 볼륨 슬라이더
- 기본값: 좌측 음소거 해제, 우측 음소거

**컴포넌트:**
- `VideoCompareModal` - 오디오 컨트롤 UI 추가

### 1.3 피드백 시스템 개선

**FeedbackForm 개선:**
- 긴급 피드백 마킹 기능 (`is_urgent`)
- API에 `is_urgent` 파라미터 전달

**FeedbackPanel 개선:**
- 긴급 피드백 필터 추가
- 긴급 피드백 카운트 표시 (빨간색 뱃지)
- Realtime 구독 안정화

**API 개선:**
- `POST /api/videos/[id]/feedbacks` - `is_urgent` 필드 지원
- `PATCH /api/feedbacks/[id]` - `is_urgent` 수정 지원

---

## 2. 수정/개선 사항

### 2.1 Cloudflare Stream URL 정리 유틸리티

**문제:** Stream URL에 잘못된 문자열이 포함된 경우가 있음

**해결:**
- `sanitizeStreamUrl()` 함수 추가
- 기본 URL 구성 함수 추가 (`getStreamThumbnailUrl`, `getStreamHlsUrl`, `getStreamDashUrl`)

**파일:**
- `src/lib/cloudflare/stream.ts` (+115 라인)

### 2.2 보드 페이지 썸네일 업로드 안정화

**개선 내용:**
- 썸네일 업로드 실패 시에도 보드 저장 진행
- 에러 핸들링 개선

### 2.3 영상 상세 페이지 HLS 에러 핸들링

**개선 내용:**
- HLS 네트워크/미디어 에러 자동 복구
- 복구 불가능한 에러 시 HLS 인스턴스 정리

### 2.4 사이드바 프로젝트 선택 개선

**개선 내용:**
- 삭제된 프로젝트 선택 시 자동 해제
- 에러 시 안전하게 처리

---

## 3. 코드 정리 (배포 준비)

### 3.1 디버그 로그 제거

**제거된 로그:**
- 영상 비교 컴포넌트 (23개)
  - 비디오 URL 로깅
  - 준비 상태 로깅
  - 재생 상태 로깅
- FeedbackPanel (2개)
  - Realtime 이벤트 로깅
  - 구독 상태 로깅
- 영상 상세 페이지 (6개)
  - HLS 초기화 로깅
  - 에러 복구 로깅

**유지된 로그:**
- console.error (실제 에러 핸들링용)

---

## 4. 오늘 발생한 버그 및 해결

### 4.1 HLS 비디오 재생/정지 충돌

**문제:** play()와 pause()가 빠르게 호출될 때 `AbortError` 발생

**해결:**
- `safePlay()`, `safePause()` 함수 구현
- play() Promise 추적 및 완료 대기 후 pause() 호출
- AbortError는 무시 처리

**패턴:**
```typescript
const safePlay = async (video: HTMLVideoElement) => {
  try {
    const playPromise = video.play();
    playPromisesRef.current.set(video, playPromise);
    await playPromise;
  } catch (e) {
    if (e instanceof DOMException && e.name === 'AbortError') {
      return; // 무시
    }
    console.error('재생 실패:', e);
  } finally {
    playPromisesRef.current.delete(video);
  }
};
```

### 4.2 영상 비교 동기화 드리프트

**문제:** 두 영상의 재생 시간이 점점 벌어짐

**해결:**
- 재생 시작 전 시간 동기화 (0.1초 이상 차이 시)
- seek 이벤트 시 동기화
- throttled timeUpdate (250ms)

---

## 5. 파일 변경 통계

```
수정된 파일: 26개
삭제된 파일: 2개 (불필요한 문서)
총 변경 라인: +909 / -594
```

### 주요 변경 파일:
- `src/components/video/compare/SliderCompare.tsx` (+126)
- `src/components/video/compare/WipeCompare.tsx` (+121)
- `src/components/video/compare/SideBySideCompare.tsx` (+121)
- `src/components/video/compare/OverlayCompare.tsx` (+121)
- `src/lib/cloudflare/stream.ts` (+115)
- `src/app/(dashboard)/projects/[id]/boards/[boardId]/page.tsx` (+105)
- `src/components/video/FeedbackForm.tsx` (+63)

---

## 6. 규칙 업데이트

### ERROR_PREVENTION.md 추가 예정:
- §26: HLS 비디오 play/pause 충돌 방지 패턴
- §27: 영상 비교 시간 동기화 패턴

---

## 7. 다음 작업 예정

1. AI 기능 통합 (음성 피드백, AI 요약)
2. 커뮤니티 기능 개발
3. 분석 대시보드 개발
4. 타임라인 기능 개발

---

## 8. 참고 사항

- 디버그 로그 제거 완료로 프로덕션 배포 준비 완료
- HLS 스트리밍은 Cloudflare Stream과 완전 호환
- 영상 비교 모달에서 개별 오디오 제어 가능

---

**작성자:** Claude Code
**커밋:** 08.영상 비교 HLS 지원 + 오디오 제어 + 피드백 개선 + 로그 정리
