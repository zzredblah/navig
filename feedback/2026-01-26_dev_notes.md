# 개발자 노트 - 2026-01-26

> Sprint 5-6 영상 버전 관리 + 피드백 시스템, 채팅 시스템, R2 스토리지 마이그레이션

---

## 1. 영상 버전 관리 시스템 (Sprint 5-6)

### 1.1 주요 기능

| 기능 | 설명 | 경로 |
|------|------|------|
| 영상 업로드 | 드래그앤드롭, 멀티파트 업로드 (최대 2GB) | `/projects/[id]/videos` |
| 버전 관리 | 자동 버전 번호 증가, 변경사항 기록 | `/projects/[id]/videos` |
| 영상 재생 | HTML5 비디오 플레이어 | 모달 또는 리뷰 페이지 |
| 버전 비교 | 두 버전 나란히 재생 | 버전 목록에서 선택 |
| 전체 영상 목록 | 모든 프로젝트의 영상 한눈에 보기 | `/videos` |

### 1.2 API 엔드포인트

```
GET    /api/videos                    - 전체 영상 목록
GET    /api/videos/[id]               - 영상 상세
PATCH  /api/videos/[id]               - 영상 수정
DELETE /api/videos/[id]               - 영상 삭제
POST   /api/videos/[id]/complete      - 업로드 완료 처리

GET    /api/projects/[id]/videos      - 프로젝트 영상 목록
POST   /api/projects/[id]/videos      - 새 영상 업로드 시작
```

### 1.3 컴포넌트

| 컴포넌트 | 용도 |
|---------|------|
| `VideoUploader.tsx` | 드래그앤드롭 업로드 모달 |
| `VideoPlayer.tsx` | HTML5 비디오 플레이어 |
| `VideoVersionList.tsx` | 버전 목록 |
| `VideoCompareModal.tsx` | 버전 비교 (나란히 재생) |

### 1.4 DB 마이그레이션

- `supabase/migrations/00007_video_versions.sql`
  - `video_status` ENUM (uploading, processing, ready, error)
  - `video_versions` 테이블 (버전 정보, 메타데이터)
  - 자동 버전 번호 증가 트리거
  - RLS 정책

---

## 2. 프레임 단위 피드백 시스템

### 2.1 주요 기능

| 기능 | 설명 |
|------|------|
| 피드백 작성 | 현재 재생 시점에 피드백 추가 |
| 타임라인 마커 | 피드백 위치를 타임라인에 표시 |
| 피드백 상태 | 열림/해결됨/수정안함 상태 관리 |
| 답글 기능 | 피드백에 답글 작성 |
| 타임스탬프 이동 | 피드백 클릭 시 해당 시점으로 이동 |
| 화면 드로잉 | Canvas 기반 화면 영역 마킹 |

### 2.2 API 엔드포인트

```
GET    /api/videos/[id]/feedbacks     - 피드백 목록
POST   /api/videos/[id]/feedbacks     - 피드백 작성

GET    /api/feedbacks/[id]            - 피드백 상세
PATCH  /api/feedbacks/[id]            - 피드백 수정
DELETE /api/feedbacks/[id]            - 피드백 삭제

GET    /api/feedbacks/[id]/replies    - 답글 목록
POST   /api/feedbacks/[id]/replies    - 답글 작성
```

### 2.3 컴포넌트

| 컴포넌트 | 용도 |
|---------|------|
| `FeedbackPanel.tsx` | 피드백 목록 사이드 패널 |
| `FeedbackForm.tsx` | 피드백 작성 폼 |
| `FeedbackItem.tsx` | 피드백 아이템 (상태, 답글) |
| `FeedbackMarker.tsx` | 타임라인 마커 |
| `DrawingCanvas.tsx` | 화면 영역 드로잉 |

### 2.4 DB 마이그레이션

- `supabase/migrations/00008_video_feedbacks.sql`
  - `feedback_status` ENUM (open, resolved, wont_fix)
  - `video_feedbacks` 테이블 (타임스탬프, 내용, 드로잉 데이터)
  - `feedback_replies` 테이블 (답글)
  - RLS 정책

---

## 3. Cloudflare R2 스토리지

### 3.1 구현 내용

| 기능 | 설명 |
|------|------|
| 단일 파일 업로드 | `uploadFile()` - 10MB 미만 |
| 멀티파트 업로드 | `initiateMultipartUpload()`, `completeMultipartUpload()` |
| Presigned URL | 클라이언트 직접 업로드용 |
| 파일 삭제 | `deleteFile()` |

### 3.2 파일

- `src/lib/cloudflare/r2.ts` - R2 클라이언트 라이브러리
- `src/hooks/use-video-upload.ts` - 영상 업로드 훅

### 3.3 환경 변수

```env
R2_ACCOUNT_ID=
R2_ACCESS_KEY_ID=
R2_SECRET_ACCESS_KEY=
R2_BUCKET_AVATARS=navig-avatars
R2_BUCKET_VIDEOS=navig-videos
R2_PUBLIC_URL_AVATARS=
R2_PUBLIC_URL_VIDEOS=
```

### 3.4 아바타 업로드 마이그레이션

- `src/app/api/profile/avatar/route.ts` - Supabase Storage → R2로 변경

---

## 4. 채팅 시스템

### 4.1 주요 기능

| 기능 | 설명 |
|------|------|
| 채팅방 생성 | 프로젝트별 채팅방 |
| 실시간 메시지 | Optimistic Update 패턴 |
| 파일 첨부 | R2 업로드 (이미지, 비디오, 문서) |
| 리액션 | 이모지 리액션 |
| 답장 | 메시지 답장 기능 |
| 카카오톡 스타일 UI | 메시지 그룹화, 비차단 전송 |

### 4.2 API 엔드포인트

```
GET/POST   /api/chat/rooms                   - 채팅방 목록/생성
GET        /api/chat/rooms/[id]              - 채팅방 상세
GET/POST   /api/chat/rooms/[id]/messages     - 메시지 목록/전송
GET        /api/chat/rooms/[id]/members      - 멤버 목록
POST       /api/chat/attachments             - 파일 업로드
POST/DEL   /api/chat/messages/[id]/reactions - 리액션
PATCH/DEL  /api/chat/messages/[id]           - 메시지 수정/삭제
GET        /api/users/search                 - 사용자 검색
```

### 4.3 컴포넌트

| 컴포넌트 | 용도 |
|---------|------|
| `ChatList.tsx` | 채팅방 목록 |
| `ChatRoom.tsx` | 채팅방 (메시지 목록) |
| `ChatMessage.tsx` | 메시지 아이템 |
| `ChatInput.tsx` | 메시지 입력 |
| `EmojiPicker.tsx` | 이모지 선택 |
| `CreateChatRoomModal.tsx` | 채팅방 생성 모달 |

### 4.4 DB 마이그레이션

- `supabase/migrations/00009_chat_system.sql`
  - `chat_rooms`, `chat_room_members` 테이블
  - `chat_messages`, `chat_message_reactions` 테이블
  - RLS 정책
- `supabase/migrations/00010_chat_rls_insert.sql`
  - 메시지 INSERT RLS 수정

### 4.5 버그 수정

| 증상 | 원인 | 해결 |
|------|------|------|
| 리액션 500 에러 | `upsert + single()` 조합 | 존재 여부 먼저 확인 후 조건부 삽입 |
| 실시간 미표시 | 서버 응답 대기 후 렌더 | Optimistic Update 적용 |
| "알 수 없음" 표시 | 중첩 조인 미작동 | 별도 쿼리로 분리 |
| 포커스 사라짐 | 상태 초기화로 리렌더 | `setTimeout(..., 0)`으로 포커스 |
| 연속 전송 지연 | `isSending` 상태 블로킹 | 비차단 패턴 적용 |

---

## 5. Claude Code 멀티 에이전트 설정

### 5.1 생성된 에이전트

| 에이전트 | 모델 | 역할 |
|---------|------|------|
| `frontend-dev` | Sonnet | React/Next.js 개발 |
| `api-dev` | Sonnet | API/Supabase 개발 |
| `code-reviewer` | **Opus** | 심층 코드 리뷰 |
| `db-analyst` | Sonnet | DB 스키마/RLS 분석 |
| `researcher` | Sonnet | 코드베이스 탐색 |
| `tester` | Sonnet | 테스트 실행/분석 |

### 5.2 파일

- `.claude/agents/*.md` - 6개 에이전트 정의
- `.claude/docs/TEAM_MODE_GUIDE.md` - 팀 모드 가이드
- `.claude/CLAUDE.md` - 에이전트 섹션 추가

---

## 6. UI/UX 개선

| 개선 항목 | 내용 |
|----------|------|
| 사이드바 | "영상", "채팅" 메뉴 추가 |
| Breadcrumb | "video" → "영상" 한글화, 링크 연결 수정 |
| 프로젝트 상세 | 영상 버전 관리 카드 추가 |
| 새 UI 컴포넌트 | alert-dialog, popover, progress, slider |

---

## 7. 규칙 문서 업데이트

### ERROR_PREVENTION.md (v2.1 → v2.2)

| 섹션 | 추가 내용 |
|------|----------|
| §6 | R2 스토리지 업로드 패턴 (멀티파트 포함) |
| §11.1 | Supabase 중첩 조인 미작동 → 별도 쿼리 패턴 |
| §11.2 | `upsert + ignoreDuplicates + single()` 금지 |
| §12 | 실시간 채팅 UX 패턴 (Optimistic Update, 그룹화 등) |

### CODING_STANDARDS.md

- 기술 스택에 Cloudflare R2 추가

---

## 8. 신규 파일 목록

### 영상 시스템
```
src/app/(dashboard)/videos/page.tsx
src/app/(dashboard)/projects/[id]/videos/page.tsx
src/app/(dashboard)/projects/[id]/videos/[videoId]/page.tsx
src/app/api/videos/route.ts
src/app/api/videos/[id]/route.ts
src/app/api/videos/[id]/complete/route.ts
src/app/api/videos/[id]/feedbacks/route.ts
src/app/api/projects/[id]/videos/route.ts
src/app/api/feedbacks/[id]/route.ts
src/app/api/feedbacks/[id]/replies/route.ts
src/components/video/*.tsx (9개)
src/hooks/use-video-upload.ts
src/types/video.ts
src/types/feedback.ts
supabase/migrations/00007_video_versions.sql
supabase/migrations/00008_video_feedbacks.sql
```

### 채팅 시스템
```
src/app/(dashboard)/chat/page.tsx
src/app/(dashboard)/chat/[roomId]/page.tsx
src/app/api/chat/rooms/route.ts
src/app/api/chat/rooms/[id]/route.ts
src/app/api/chat/rooms/[id]/messages/route.ts
src/app/api/chat/rooms/[id]/members/route.ts
src/app/api/chat/messages/[id]/route.ts
src/app/api/chat/messages/[id]/reactions/route.ts
src/app/api/chat/attachments/route.ts
src/app/api/users/search/route.ts
src/components/chat/*.tsx (6개)
src/hooks/use-chat-unread.ts
src/types/chat.ts
supabase/migrations/00009_chat_system.sql
supabase/migrations/00010_chat_rls_insert.sql
```

### 인프라
```
src/lib/cloudflare/r2.ts
.claude/agents/*.md (6개)
.claude/docs/TEAM_MODE_GUIDE.md
```

---

## 9. 수정된 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `.claude/CLAUDE.md` | 에이전트 섹션 추가 |
| `.claude/rules/CODING_STANDARDS.md` | R2 스택 추가 |
| `.claude/rules/ERROR_PREVENTION.md` | §6, §11, §12 추가 |
| `.env.example` | R2 환경 변수 추가 |
| `package.json` | @aws-sdk/client-s3 패키지 추가 |
| `src/app/(dashboard)/projects/[id]/page.tsx` | 영상 카드 추가 |
| `src/app/api/profile/avatar/route.ts` | R2 마이그레이션 |
| `src/app/globals.css` | 비디오 플레이어 스타일 |
| `src/components/layout/Sidebar.tsx` | 영상, 채팅 메뉴 추가 |
| `src/components/ui/breadcrumb.tsx` | 한글화, 링크 수정 |
| `src/types/database.ts` | 피드백 타입 추가 |

---

## 10. 사용자 작업 필요

### Supabase 마이그레이션 실행
```bash
npx supabase db push
# 또는 대시보드에서 직접 실행:
# - 00007_video_versions.sql
# - 00008_video_feedbacks.sql
# - 00009_chat_system.sql
# - 00010_chat_rls_insert.sql
```

### Cloudflare R2 설정
1. R2 버킷 생성: `navig-avatars`, `navig-videos`
2. 퍼블릭 액세스 활성화
3. CORS 설정 추가
4. `.env.local`에 환경 변수 설정

---

## 11. 알려진 제한사항

1. **영상 메타데이터**: 클라이언트 HTML5 Video API로 추출 (서버 FFmpeg 미사용)
2. **썸네일 생성**: 클라이언트 Canvas API 사용 (첫 프레임)
3. **실시간 동기화**: Supabase Realtime 미연동 (새로고침 필요)
4. **모바일 피드백**: 데스크톱 사이드바만 지원 (모바일 모달 추후)
