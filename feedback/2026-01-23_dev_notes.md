# 개발자 노트 - 2026-01-23

> 마지막 커밋(`2d91c1c vercel 추가`) 이후 오늘 전체 변경 사항

---

## 1. 문서 관리 시스템 (전체 신규)

### 1.1 DB 스키마
- **마이그레이션 00004**: `document_templates`, `documents`, `document_versions`, `signatures` 테이블 생성
- **마이그레이션 00005**: `documents.deleted_at` 컬럼 추가 (소프트 삭제)
- **타입**: `DocumentType`, `DocumentStatus`, `TemplateField` 등 타입 정의 (`src/types/database.ts`)

### 1.2 문서 CRUD API
| 경로 | 메서드 | 설명 |
|------|--------|------|
| `/api/documents` | GET | 문서 목록 (타입/상태 필터) |
| `/api/documents` | POST | 문서 생성 (템플릿 기반) |
| `/api/documents/[id]` | GET | 문서 상세 |
| `/api/documents/[id]` | PATCH | 문서 수정 (버전 자동 증가) |
| `/api/documents/[id]` | DELETE | 소프트 삭제 |
| `/api/documents/[id]/status` | PATCH | 상태 변경 (제출/승인/반려) |
| `/api/documents/[id]/sign` | POST | 전자 서명 |
| `/api/documents/[id]/versions` | GET | 버전 히스토리 |
| `/api/documents/[id]/pdf` | GET | PDF 생성/다운로드 |
| `/api/documents/[id]/restore` | POST | 휴지통에서 복원 |
| `/api/documents/trash` | GET | 삭제된 문서 목록 |
| `/api/templates` | GET/POST | 템플릿 CRUD |
| `/api/templates/[id]` | PATCH/DELETE | 템플릿 수정/삭제 |
| `/api/projects/[id]/documents` | GET | 프로젝트별 문서 목록 |

### 1.3 문서 페이지
- **문서 목록** (`/documents`): 타입별 탭(전체/요청서/견적서/계약서), 상태 필터, 생성 모달
- **문서 상세** (`/documents/[id]`): 미리보기, 상태 변경, 버전 비교(diff), 서명, PDF 다운로드/인쇄
- **문서 편집** (`/documents/[id]/edit`): 템플릿 필드 폼, 실시간 미리보기, 자동저장(30초)
- **휴지통** (`/documents/trash`): 삭제된 문서 목록, 복원/영구삭제
- **프로젝트별 문서** (`/projects/[id]/documents`): 프로젝트 하위 문서 목록

### 1.4 문서 컴포넌트
- `DocumentStatusBadge` - 상태별 색상 뱃지 (작성중/검토대기/승인/반려/서명완료)
- `DocumentPreview` - 문서 미리보기 (A4 스타일 렌더링)
- `CreateDocumentModal` - 문서 생성 다이얼로그 (템플릿 선택 → 필드 입력)
- `RejectReasonModal` - 반려 사유 입력 모달
- `SignaturePad` - 캔버스 기반 전자 서명 패드

### 1.5 PDF 기능
- `html2canvas` + `jspdf` 패키지 추가
- `src/lib/pdf-download.ts`: API에서 HTML 반환 → PDF 변환 → 다운로드
- 인쇄 모드: 새 탭에서 A4 레이아웃 표시

### 1.6 유효성 검증
- `src/lib/validations/document.ts`: 문서 생성/수정 Zod 스키마
- `src/__tests__/validations/document.test.ts`: Vitest 단위 테스트

---

## 2. 대시보드 고도화

### 2.1 통계 카드 개선
- 기존: 프로젝트 수, 멤버 수만 표시
- 변경: 진행중 프로젝트, 협업 멤버, 전체 문서, 최근 활동 4개 통계 카드
- 각 카드 그라데이션 배경 + 아이콘 적용

### 2.2 차트 추가
- `recharts` 패키지 추가
- `DashboardCharts.tsx`: 프로젝트 상태 도넛 차트 + 문서 현황 바 차트
- 데이터: 실시간 DB에서 집계

### 2.3 최근 프로젝트 목록
- 프로젝트별 멤버 수, 문서 수 표시
- 생성일/수정일 메타데이터 추가
- 모바일: 날짜 숨김, flex-wrap 적용

---

## 3. 팀 멤버 관리 (신규)

### 3.1 페이지
- `/team`: 전체 프로젝트 멤버 통합 목록
- 역할별 뱃지 (소유자/편집자/뷰어)
- 멤버 초대 다이얼로그 (이메일 입력 → 프로젝트 선택)
- 멤버 제거 기능

### 3.2 API
- `GET /api/team`: 사용자의 모든 프로젝트 멤버 조회
- 기존 `/api/projects/[id]/members` 활용

---

## 4. 사이드바 설정 기능 (신규)

### 4.1 구현 내용
- **마이그레이션 00006**: `profiles.sidebar_config` JSONB 컬럼 추가
- **타입**: `SidebarConfig` 인터페이스 (`{ hidden?: string[] }`)
- **API**: `PATCH /api/profile/sidebar` - hidden 배열 저장
- **설정 페이지** (`/settings`): 체크박스로 메뉴 항목 표시/숨김 토글
- **Sidebar 컴포넌트**: `sidebarConfig` prop 기반 메뉴 필터링
- **제약**: 대시보드, 설정은 항상 표시 (숨김 불가)

### 4.2 데이터 흐름
`layout.tsx` → profiles에서 sidebar_config 조회 → `MainLayout` → `Sidebar` prop 전달

---

## 5. 프로필 설정 (신규)

### 5.1 페이지
- `/settings/profile`: 아바타 업로드, 기본 정보(이름/연락처/회사), 비밀번호 변경

### 5.2 API
| 경로 | 메서드 | 설명 |
|------|--------|------|
| `/api/profile` | GET | 현재 프로필 조회 |
| `/api/profile` | PATCH | 프로필 수정 (name, phone, company) |
| `/api/profile/avatar` | POST | 아바타 업로드 (Supabase Storage) |
| `/api/profile/password` | POST | 비밀번호 변경 (현재 PW 확인 후) |

### 5.3 아바타 업로드
- Supabase Storage `avatars` 버킷 사용
- 파일명: `{user_id}.{ext}` (upsert 방식)
- 서버에서 File → Buffer 변환 후 Admin 클라이언트로 업로드
- 캐시 무효화: URL에 타임스탬프 쿼리 파라미터 추가

---

## 6. UI/UX 개선

### 6.1 모바일 반응형 수정
- **대시보드 최근 프로젝트**: `flex-wrap` + 모바일 날짜 숨김
- **문서 목록 카드**: `flex-col sm:flex-row` + `truncate`
- **문서 상세 헤더**: 제목+버튼 세로 스택 + 버튼 `size="sm"` + `flex-wrap`
- **문서 편집 헤더**: 동일 패턴 적용

### 6.2 알림 벨
- DropdownMenu 추가, "알림이 없습니다" 빈 상태 표시

### 6.3 프로필 폼 입력
- raw `<input>` 요소에 `bg-white text-gray-900` 명시 (검은색 배경 버그 수정)
- `focus:outline-none` + `placeholder:text-gray-400` 추가

### 6.4 헤더 네비게이션
- 프로필 드롭다운: `/profile` → `/settings/profile`로 변경

---

## 7. 인프라/설정

### 7.1 패키지 추가
- `recharts` - 차트 라이브러리
- `html2canvas` + `jspdf` - PDF 생성
- `vitest` + `@testing-library/react` + `jsdom` - 테스트 환경
- `@vitejs/plugin-react` - Vitest React 지원

### 7.2 테스트 설정
- `vitest.config.ts` 생성
- `src/__tests__/setup.ts`: testing-library 설정
- `npm run test` / `npm run test:watch` 스크립트 추가

### 7.3 Breadcrumb 컴포넌트
- `/settings/profile` 등 하위 경로 라벨 매핑 추가

---

## 8. 규칙 문서 업데이트

### 8.1 DESIGN_SYSTEM.md (v2.0 → v3.0)
- §8.3 페이지 헤더 반응형 필수 패턴
- §8.4 메타데이터 목록 반응형 패턴
- §8.5 카드 내 가로 레이아웃 패턴
- §9 폼 입력(raw input) 스타일링 규칙
- §10 빈 상태 & 피드백 규칙
- §12 체크리스트 세분화

### 8.2 ERROR_PREVENTION.md (v1.0 → v2.0)
- §6 Supabase Storage 파일 업로드 (File→Buffer, Admin 클라이언트)
- §8 모바일 반응형 버그 방지
- §9 Input/Form UI 스타일링
- §10 빈 상태/피드백
- §11 체크리스트 업데이트

### 8.3 CLAUDE.md
- rules 파일 참조 테이블 추가

---

## 9. 버그 수정 이력

| 증상 | 원인 | 해결 |
|------|------|------|
| 프로필 input 검은색 | CSS 변수 상속, bg/text 미지정 | `bg-white text-gray-900` 명시 |
| 알림 벨 클릭 무반응 | DropdownMenu 미적용 | DropdownMenu + 빈 상태 UI 추가 |
| 아바타 업로드 500 에러 | File 객체 직접 전달 + RLS | Buffer 변환 + Admin 클라이언트 |
| 모바일 헤더/카드 넘침 | `flex justify-between` only | `flex-col sm:flex-row` + `flex-wrap` |

---

## 10. Supabase 설정 필요사항

- [ ] 마이그레이션 00004 실행 (문서 스키마)
- [ ] 마이그레이션 00005 실행 (소프트 삭제)
- [ ] 마이그레이션 00006 실행 (sidebar_config)
- [ ] Storage 버킷 `avatars` 생성 (Public, 2MB, image/* 허용)
- [ ] Storage RLS 정책 설정 (authenticated 유저 업로드 허용)
