# NAVIG 개발 일지 - 2026-02-03

## 오늘의 작업 요약

편집 워크스페이스 영상 업로드 기능 구현 및 HLS 초기화 버그 수정. 영상 피드백 페이지에서 자막 생성 기능 제거 (편집 워크스페이스로 이동).

---

## 1. 버그 수정

### 1.1 HLS Manifest 파싱 에러 수정

**문제:**
- 편집 워크스페이스 진입 시 "Manifest: Line: 1, column: 1, Syntax error" 에러 발생
- `videoUrl`이 `null`인 상태에서 HLS 플레이어가 초기화되면서 발생

**원인:**
- `EditWorkspace.tsx`에서 `videoUrl` 존재 여부와 관계없이 항상 `VideoPreview` 컴포넌트 렌더링
- hls.js가 빈 URL에서 manifest를 로드하려다 실패

**해결:**
- `videoUrl` 존재 시에만 `VideoPreview` 렌더링
- `videoUrl` 없으면 `VideoUploader` 컴포넌트 표시

**수정 파일:**
- `src/components/editing/workspace/EditWorkspace.tsx`

---

### 1.2 편집 워크스페이스 영상 업로드 불가 수정

**문제:**
- 편집 워크스페이스에서 영상 업로드 기능이 없음
- 탐색기/드래그 앤 드롭 모두 동작하지 않음

**원인:**
- `CreateEditModal`에서 "워크스페이스에서 업로드" 안내만 표시
- 실제 업로드 컴포넌트 및 API 미구현

**해결:**
- `VideoUploader` 컴포넌트 신규 구현
- 업로드 API 엔드포인트 3개 신규 구현
- Zustand store에 `setVideoUrl`, `setVideoDuration` 액션 추가

---

## 2. 신규 기능 개발

### 2.1 VideoUploader 컴포넌트

**파일:** `src/components/editing/workspace/VideoUploader.tsx`

**기능:**
- 드래그 앤 드롭 영상 업로드
- 파일 탐색기 선택 업로드
- 멀티파트 업로드 (10MB 청크)
- 업로드 진행률 표시
- 영상 duration 자동 추출
- 파일 형식 검증 (MP4, MOV, WebM, AVI)
- 파일 크기 제한 (최대 5GB)

---

### 2.2 업로드 API 엔드포인트

| API | 설명 |
|-----|------|
| `POST /api/projects/[id]/edits/[editId]/upload` | 멀티파트 업로드 시작, uploadId 및 presigned URLs 반환 |
| `POST /api/projects/[id]/edits/[editId]/upload/part-url` | 추가 part용 presigned URL 발급 |
| `POST /api/projects/[id]/edits/[editId]/upload-complete` | 업로드 완료 처리, DB 업데이트 |

**새로 추가된 파일:**
- `src/app/api/projects/[id]/edits/[editId]/upload/route.ts`
- `src/app/api/projects/[id]/edits/[editId]/upload/part-url/route.ts`
- `src/app/api/projects/[id]/edits/[editId]/upload-complete/route.ts`

---

### 2.3 Zustand Store 업데이트

**파일:** `src/stores/edit-workspace-store.ts`

**추가된 액션:**
```typescript
setVideoUrl: (url: string | null) => void
setVideoDuration: (duration: number) => void
```

**setVideoDuration 동작:**
- `videoDuration` 상태 업데이트
- `metadata.trim.endTime`을 duration으로 자동 설정

---

## 3. 기능 이동/제거

### 3.1 자막 생성 기능 제거 (영상 피드백 페이지)

**문제:**
- 자막 생성이 영상 피드백 페이지와 편집 워크스페이스 양쪽에 존재
- 기능 중복으로 사용자 혼란

**해결:**
- 영상 피드백 페이지에서 `SubtitleGenerator` 컴포넌트 제거
- 자막 생성은 편집 워크스페이스에서만 제공

**수정 파일:**
- `src/app/(dashboard)/projects/[id]/videos/[videoId]/page.tsx`
  - `SubtitleGenerator` import 제거
  - `Languages` 아이콘 import 제거
  - AI 기능 섹션에서 자막 생성 UI 제거
  - 영상 버전이 2개 이상일 때만 `VideoDiffAnalyzer` 표시

---

## 4. 규칙 업데이트

### ERROR_PREVENTION.md v2.8

**추가된 섹션:**
- **§29.1**: HLS Manifest 파싱 에러 방지 (videoUrl 체크 필수)
- **§29.2**: 편집 워크스페이스 영상 업로드 패턴
- **§29.3**: 기능 위치 원칙 (피드백 vs 편집)
- **§29.4**: Zod 스키마와 TypeScript 타입 일치 (.transform() 패턴)
- **§30**: 편집 워크스페이스 체크리스트
- **§31**: 관련 파일 목록

---

## 5. 파일 변경 통계

```
총 변경 파일: 8개
새로 추가된 파일: 4개
수정된 파일: 4개
```

### 새로 추가된 파일:

| 파일 | 설명 |
|------|------|
| `src/components/editing/workspace/VideoUploader.tsx` | 영상 업로더 컴포넌트 |
| `src/app/api/projects/[id]/edits/[editId]/upload/route.ts` | 업로드 시작 API |
| `src/app/api/projects/[id]/edits/[editId]/upload/part-url/route.ts` | Part URL 발급 API |
| `src/app/api/projects/[id]/edits/[editId]/upload-complete/route.ts` | 업로드 완료 API |

### 수정된 파일:

| 파일 | 변경 내용 |
|------|----------|
| `src/app/(dashboard)/projects/[id]/videos/[videoId]/page.tsx` | 자막 생성 제거 |
| `src/components/editing/workspace/EditWorkspace.tsx` | 조건부 렌더링 (VideoUploader) |
| `src/stores/edit-workspace-store.ts` | setVideoUrl, setVideoDuration 추가 |
| `.claude/rules/ERROR_PREVENTION.md` | §29-31 추가 |

---

## 6. 기술적 세부사항

### 6.1 멀티파트 업로드 플로우

```
1. 클라이언트: 파일 선택/드롭
2. 클라이언트 → API: POST /upload (파일 메타데이터)
3. API: R2 initiateMultipartUpload 호출
4. API → 클라이언트: uploadId, key, presigned URLs (최대 10개)
5. 클라이언트: 각 청크(10MB)를 presigned URL로 직접 업로드
6. 클라이언트: 추가 청크 필요 시 POST /upload/part-url
7. 클라이언트: 영상 duration 추출 (HTMLVideoElement)
8. 클라이언트 → API: POST /upload-complete (parts, duration)
9. API: R2 completeMultipartUpload 호출
10. API: edit_projects 테이블 업데이트 (source_url, source_key, original_duration)
```

### 6.2 영상 Duration 추출

```typescript
function getVideoDuration(file: File): Promise<number> {
  return new Promise((resolve, reject) => {
    const video = document.createElement('video');
    video.preload = 'metadata';
    video.onloadedmetadata = () => {
      window.URL.revokeObjectURL(video.src);
      resolve(video.duration);
    };
    video.onerror = () => {
      window.URL.revokeObjectURL(video.src);
      reject(new Error('영상 메타데이터 로드 실패'));
    };
    video.src = URL.createObjectURL(file);
  });
}
```

### 6.3 Zod .transform() 패턴

```typescript
// API 응답 타입과 정확히 일치시키기 위해 .transform() 사용
const schema = z.object({
  parts: z.array(z.object({
    partNumber: z.number().positive(),
    etag: z.string().min(1),
  })).transform((parts): UploadPartResult[] =>
    parts.map(p => ({
      partNumber: p.partNumber,
      etag: p.etag,
    }))
  ),
});
```

---

## 7. 다음 작업 예정

1. 편집 워크스페이스 자막 편집 패널 구현
2. 텍스트 오버레이 기능 구현
3. 필터/색보정 기능 구현
4. 편집 자동 저장 기능 구현
5. 편집 완료 후 영상 등록 플로우 구현

---

## 8. 참고 사항

- 업로드 API는 편집 프로젝트 소유자만 접근 가능 (created_by 체크)
- draft 상태의 편집 프로젝트만 영상 업로드 가능
- R2 멀티파트 업로드는 'videos' 버킷 사용

---

**작성자:** Claude Code
**커밋:** 09.편집 워크스페이스 영상 업로드 + HLS 버그 수정 + 자막 생성 위치 정리
