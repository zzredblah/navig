# 개발자 노트 - 2026-01-27

> Sprint 7: 알림 시스템 추가 및 채팅 기능 고도화 (카카오톡 스타일)

---

## 1. 알림 시스템 (Notifications)

### 1.1 주요 기능

| 기능 | 설명 | 경로 |
|------|------|------|
| 알림 목록 | 읽음/안읽음 상태, 무한 스크롤 | `/notifications` |
| 알림 벨 | 헤더 알림 아이콘 + 뱃지 | 모든 페이지 |
| 알림 설정 | 알림 유형별 on/off, 이메일/푸시/사운드 | `/notifications` 탭 |
| 실시간 알림 | Supabase Realtime 구독 | 전역 |
| 알림 사운드 | 새 알림 시 효과음 재생 | 전역 |

### 1.2 API 엔드포인트

```
GET    /api/notifications              - 알림 목록 (페이지네이션)
PATCH  /api/notifications              - 전체 읽음 처리
PATCH  /api/notifications/[id]         - 개별 읽음 처리
DELETE /api/notifications/[id]         - 알림 삭제

GET    /api/notification-settings      - 알림 설정 조회
PUT    /api/notification-settings      - 알림 설정 저장
```

### 1.3 컴포넌트

| 컴포넌트 | 용도 |
|---------|------|
| `NotificationBell.tsx` | 헤더 알림 아이콘 + 드롭다운 |
| `NotificationList.tsx` | 알림 목록 (무한 스크롤) |
| `NotificationItem.tsx` | 알림 아이템 |
| `NotificationSettings.tsx` | 알림 설정 폼 |

### 1.4 훅

| 훅 | 용도 |
|----|------|
| `use-notifications.ts` | 알림 목록 CRUD |
| `use-notification-settings.ts` | 알림 설정 관리 |
| `use-realtime-notifications.ts` | 실시간 구독 + 사운드 |

### 1.5 DB 마이그레이션

- `supabase/migrations/00011_notifications.sql`
  - `notification_type` ENUM (feedback_new, feedback_reply, ...)
  - `notifications` 테이블
  - `notification_settings` 테이블
  - RLS 정책

---

## 2. 대시보드 업그레이드

### 2.1 새 컴포넌트

| 컴포넌트 | 용도 |
|---------|------|
| `StatCards.tsx` | 통계 카드 (프로젝트, 영상, 피드백, 문서) |
| `ActivityFeed.tsx` | 최근 활동 피드 |
| `UrgentSection.tsx` | 긴급 피드백 섹션 |
| `RecentProjects.tsx` | 최근 프로젝트 목록 |
| `DashboardSkeleton.tsx` | 로딩 스켈레톤 |

### 2.2 API 엔드포인트

```
GET /api/dashboard/stats     - 통계 데이터
GET /api/dashboard/activity  - 최근 활동
GET /api/dashboard/urgent    - 긴급 피드백 (해결 안 된 것만)
```

---

## 3. 채팅 기능 고도화 (카카오톡 스타일)

### 3.1 새 기능

| 기능 | 설명 |
|------|------|
| 메시지 삭제 | 모두에게서 삭제 / 나에게서만 삭제 |
| 대화내용 지우기 | 선택 삭제 / 전체 삭제 |
| 다중 선택 모드 | 여러 메시지 선택 후 일괄 삭제 |
| 채팅방 나가기 | 그룹 채팅방에서 나가기 (1:1은 불가) |
| 드래그 앤 드롭 | 채팅방 전체 영역에서 파일 드롭 |

### 3.2 새 API 엔드포인트

```
POST /api/chat/rooms/[id]/leave  - 채팅방 나가기
POST /api/chat/rooms/[id]/clear  - 대화내용 전체 삭제
```

### 3.3 메시지 삭제 로직

| 삭제 유형 | 동작 |
|----------|------|
| 모두에게서 삭제 | `is_deleted=true` 소프트 삭제 (본인 메시지만) |
| 나에게서만 삭제 | `chat_message_deletions` 테이블에 기록 |

### 3.4 UI 개선

- 삭제 다이얼로그: iOS 스타일 액션 시트
- 가운데 정렬, 깔끔한 옵션 목록
- "모두에게서 삭제"는 빨간색 텍스트 (빨간 배경 X)
- 드래그 오버레이: 전체 화면 블러 + 카드 형태

### 3.5 DB 마이그레이션

- `supabase/migrations/00012_chat_message_deletions.sql`
  - `chat_message_deletions` 테이블 (나에게만 삭제 기록)
  - `chat_room_members.cleared_at` 컬럼 (전체 삭제 시점)
  - RLS 정책

---

## 4. 버그 수정

| 증상 | 원인 | 해결 |
|------|------|------|
| 알림 뱃지 안 사라짐 | `enabled: isOpen` 조건 | `enabled: true`로 변경 |
| 채팅 뱃지 안 사라짐 | 읽음 처리 후 갱신 안 됨 | 커스텀 이벤트로 갱신 트리거 |
| 긴급 항목 24시간 후 사라짐 | `.gte('created_at', oneDayAgo)` 필터 | 해당 필터 제거 |
| 마이그레이션 미적용 시 메시지 안 보임 | `cleared_at`, `chat_message_deletions` 조회 실패 | 폴백 로직 추가 |

---

## 5. 기타 추가 기능

### 5.1 데드라인 리마인더 스케줄러

- `src/app/api/cron/deadline-reminder/route.ts`
- Vercel Cron으로 매일 09:00 실행
- 마감 1일 전 프로젝트 알림 생성

### 5.2 팀 멤버 API

- `src/app/api/team/members/route.ts`
- 워크스페이스/팀 멤버 목록 조회

### 5.3 Vercel 설정

- `vercel.json` - Cron 작업 설정

---

## 6. 신규 파일 목록

### 알림 시스템
```
src/app/(dashboard)/notifications/page.tsx
src/app/api/notifications/route.ts
src/app/api/notifications/[id]/route.ts
src/app/api/notification-settings/route.ts
src/components/notifications/NotificationBell.tsx
src/components/notifications/NotificationList.tsx
src/components/notifications/NotificationItem.tsx
src/components/notifications/NotificationSettings.tsx
src/hooks/use-notifications.ts
src/hooks/use-notification-settings.ts
src/hooks/use-realtime-notifications.ts
src/lib/notifications/service.ts
src/lib/sounds.ts
src/lib/validations/notification.ts
src/types/notification.ts
supabase/migrations/00011_notifications.sql
```

### 대시보드
```
src/app/api/dashboard/stats/route.ts
src/app/api/dashboard/activity/route.ts
src/app/api/dashboard/urgent/route.ts
src/components/dashboard/StatCards.tsx
src/components/dashboard/ActivityFeed.tsx
src/components/dashboard/UrgentSection.tsx
src/components/dashboard/RecentProjects.tsx
src/components/dashboard/DashboardSkeleton.tsx
src/lib/validations/dashboard.ts
```

### 채팅 확장
```
src/app/api/chat/rooms/[id]/leave/route.ts
src/app/api/chat/rooms/[id]/clear/route.ts
src/components/chat/ChatPanel.tsx
supabase/migrations/00012_chat_message_deletions.sql
```

### 기타
```
src/app/api/cron/deadline-reminder/route.ts
src/app/api/team/members/route.ts
src/components/ui/switch.tsx
src/components/ui/collapsible.tsx
src/lib/email/service.ts
vercel.json
```

---

## 7. 수정된 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `src/app/(dashboard)/dashboard/page.tsx` | 새 대시보드 컴포넌트 연동 |
| `src/app/(dashboard)/layout.tsx` | 실시간 알림 훅 추가 |
| `src/components/layout/Header.tsx` | 알림 벨 추가 |
| `src/components/layout/MainLayout.tsx` | 알림 벨 추가 |
| `src/components/layout/Sidebar.tsx` | 알림 메뉴 추가 |
| `src/components/chat/ChatRoom.tsx` | 삭제/선택/드래그앤드롭 기능 |
| `src/components/chat/ChatMessage.tsx` | 삭제 다이얼로그 UI |
| `src/components/chat/ChatInput.tsx` | 드래그앤드롭 지원 |
| `src/app/api/chat/messages/[id]/route.ts` | 삭제 유형 파라미터 |
| `src/app/api/chat/rooms/[id]/messages/route.ts` | 삭제 필터링 로직 |
| `src/hooks/use-chat-unread.ts` | 커스텀 이벤트 리스너 |
| `src/types/database.ts` | 알림 타입 추가 |
| `.claude/rules/ERROR_PREVENTION.md` | 채팅 UX 패턴 추가 |

---

## 8. 사용자 작업 필요

### Supabase 마이그레이션 실행
```bash
npx supabase db push
# 또는 대시보드에서 직접 실행:
# - 00011_notifications.sql
# - 00012_chat_message_deletions.sql
```

### Vercel Cron 활성화
- Vercel 대시보드에서 Cron 기능 확인
- `vercel.json`의 cron 설정 적용됨

---

## 9. 알려진 제한사항

1. **이메일 알림**: 서비스 구현됨, 현재 비활성화 상태
2. **푸시 알림**: 설정 UI만 존재, 실제 구현 미완료
3. **마이그레이션 필수**: 새 기능 사용 전 DB 마이그레이션 필요
