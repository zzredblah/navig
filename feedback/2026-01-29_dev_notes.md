# NAVIG 개발 일지 - 2026-01-29

## 오늘의 작업 요약

구독/결제 시스템, 워터마크 기능, Cloudflare Stream 연동, 비디오 플레이어 개선 등 Phase 2 핵심 기능 개발 완료

---

## 1. 신규 기능 개발

### 1.1 구독/결제 시스템 (Toss Payments)

**플랜 구조:**
- Free: 무료, 프로젝트 2개, 스토리지 500MB
- Basic: ₩9,900/월, 프로젝트 10개, 스토리지 5GB
- Pro: ₩29,900/월, 프로젝트 무제한, 스토리지 50GB
- Business: ₩99,000/월, 프로젝트 무제한, 스토리지 200GB, 팀 기능

**구현된 API:**
- `POST /api/payments/checkout` - 결제 시작
- `POST /api/payments/confirm` - 결제 확인/완료
- `GET /api/payments/history` - 결제 내역
- `GET /api/plans` - 플랜 목록
- `GET /api/subscriptions/me` - 내 구독 정보
- `POST /api/subscriptions/change-plan` - 플랜 변경
- `POST /api/subscriptions/cancel` - 구독 취소
- `GET /api/subscriptions/usage-details` - 상세 사용량

**신규 컴포넌트:**
- `CurrentPlanCard` - 현재 플랜 표시
- `PlanComparisonCard` - 플랜 비교 카드
- `UsageProgress` - 사용량 프로그레스 바
- `UsageDetailsCard` - 상세 사용량 카드
- `PaymentHistory` - 결제 내역 테이블
- `SidebarPlanBadge` - 사이드바 플랜 뱃지
- `UpgradePromptModal` - 업그레이드 유도 모달
- `PlanCard` - 플랜 카드 (가격 페이지)

### 1.2 사용량 추적 시스템

**추적 대상:**
- 프로젝트 수 (소유 + 참여)
- 스토리지 사용량 (영상 + 채팅 첨부파일)
- 프로젝트당 멤버 수

**핵심 파일:**
- `src/lib/usage/checker.ts` - 사용량 계산 유틸리티

### 1.3 워터마크 기능

**구현 내용:**
- 프로젝트별 워터마크 설정 (텍스트/이미지)
- 워터마크 위치, 크기, 투명도 조절
- 워터마크 적용 다운로드

**API:**
- `GET/POST /api/projects/[id]/watermark` - 워터마크 설정 조회/저장

**컴포넌트:**
- `WatermarkSettings` - 워터마크 설정 UI

### 1.4 Cloudflare Stream 연동

**기능:**
- 영상 스트리밍 (HLS/DASH)
- 적응형 비트레이트 (ABR)
- 영상 상태 확인 (processing → ready)

**API:**
- `GET /api/videos/[id]/stream-status` - 스트림 상태 확인

**파일:**
- `src/lib/cloudflare/stream.ts` - Stream API 클라이언트

### 1.5 비디오 플레이어 개선

**추가 기능:**
- 전체화면 모드
- 영상 비교 모달 (버전 비교)
- 키보드 단축키 지원
- 프로그레스 바 개선

**컴포넌트:**
- `VideoPlayer` - 메인 플레이어 (대폭 개선)
- `VideoCompareModal` - 버전 비교 모달

### 1.6 클라이언트 뷰어 페이지

**목적:** 외부 클라이언트가 영상 확인 및 피드백 제공

**라우트:**
- `/client/[projectId]/videos/[videoId]` - 클라이언트 영상 뷰어

**레이아웃:**
- `ClientLayout` - 클라이언트용 간소화된 레이아웃

---

## 2. 수정/개선 사항

### 2.1 프로젝트 생성 모달 개선
- 플랜 제한 체크 추가
- 업그레이드 유도 UI
- 사용량 표시

### 2.2 영상 업로드 개선
- 멀티파트 업로드 안정화
- 청크 크기 최적화 (10MB)
- 업로드 진행률 표시 개선

### 2.3 헤더/사이드바
- 플랜 뱃지 표시
- 로그아웃 시 데이터 정리 개선

---

## 3. 데이터베이스 마이그레이션

### 추가된 마이그레이션:
- `00019_subscriptions.sql` - 구독 테이블
- `00020_watermark.sql` - 워터마크 설정 테이블
- `00021_video_watermark_enabled.sql` - 영상별 워터마크 활성화
- `00022_cloudflare_stream.sql` - Stream 연동 컬럼

---

## 4. 오늘 발생한 버그 및 해결

### 4.1 외부 API 응답 형식 불일치
- **문제:** Cloudflare API 응답이 내부 API와 다른 구조
- **해결:** API별 응답 타입 정의, 별도 파싱 로직

### 4.2 JSONB 필드 합산 에러
- **문제:** 채팅 첨부파일 크기 합산 시 타입 에러
- **해결:** Array.isArray() 체크, 기본값 설정

### 4.3 영상 스트리밍 상태 미확인
- **문제:** 인코딩 중인 영상 재생 시도 시 에러
- **해결:** 상태 폴링 구현, ready 상태에서만 재생

### 4.4 구독 상태 판단 오류
- **문제:** 취소 예정 구독의 유효기간 미고려
- **해결:** 종합 상태 판단 함수 구현

---

## 5. 추가된 패키지

```json
{
  "hls.js": "^1.5.x",    // HLS 스트리밍 지원
  "@toss/payments": "^x.x.x"  // 결제 SDK (가상)
}
```

---

## 6. 파일 변경 통계

```
수정된 파일: 23개
새로 추가된 파일: 약 30개
총 변경 라인: +1,896 / -331
```

### 주요 변경 파일:
- `src/components/video/VideoPlayer.tsx` (+282)
- `src/app/(dashboard)/projects/[id]/videos/[videoId]/page.tsx` (+415)
- `src/hooks/use-video-upload.ts` (+383 리팩토링)
- `src/app/api/projects/[id]/videos/route.ts` (+302)

### 새로 추가된 디렉토리:
- `src/app/(client)/` - 클라이언트 뷰어
- `src/app/api/payments/` - 결제 API
- `src/app/api/subscriptions/` - 구독 API
- `src/components/subscription/` - 구독 컴포넌트
- `src/lib/toss/` - Toss Payments 클라이언트
- `src/lib/usage/` - 사용량 추적

---

## 7. 규칙 업데이트

### ERROR_PREVENTION.md 추가 항목:
- §22: 외부 API 연동 관련 (응답 형식, 인증 헤더)
- §23: 영상 스트리밍 관련 (상태 확인, HLS 호환성)
- §24: 결제/구독 관련 (JSONB 처리, 구독 상태)

### STORAGE_RULES.md 추가 항목:
- §7: 스토리지 사용량 계산 로직 문서화
- 새 파일 업로드 기능 추가 시 사용량 연동 필수

---

## 8. 다음 작업 예정

1. Toss Payments 실제 연동 테스트
2. 웹훅 처리 (`/api/webhooks/toss`)
3. 워터마크 실제 적용 로직 구현
4. 클라이언트 뷰어 피드백 기능
5. 영상 인코딩 진행률 실시간 표시

---

## 9. 참고 사항

- Cloudflare Stream API 키는 `.env`에 설정 필요
- Toss Payments는 테스트 환경으로 구현됨
- 프로덕션 전환 시 결제 API 키 교체 필요

---

**작성자:** Claude Code
**커밋:** 07.구독/결제 + 워터마크 + Cloudflare Stream + 비디오 플레이어
